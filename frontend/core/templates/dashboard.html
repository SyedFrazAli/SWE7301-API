{% extends 'base.html' %}

{% block title %}GeoScope Dashboard{% endblock %}

{% block content %}
<header class="header">
    <div class="welcome">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 8px;">
            <h1>Overview</h1>
            {% if backend_connected %}
            <span class="status-badge" style="background: #dcfce7; color: #166534">
                <span style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></span>
                System Online
            </span>
            {% else %}
            <span class="status-badge" style="background: #fee2e2; color: #991b1b">
                <span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span>
                API Disconnected
            </span>
            {% endif %}
        </div>
        <p>Welcome back, {{ username }}. Here is your geospatial intelligence summary.</p>
    </div>
    <div class="user-profile">
        <div class="avatar">{{ username|slice:":1"|upper }}</div>
        <div style="display: flex; flex-direction: column">
            <span style="font-size: 14px; font-weight: 600; color: var(--text-main)">{{ username }}</span>
            <span style="font-size: 12px; color: var(--text-muted)">{{ plan_name }}</span>
        </div>
    </div>
</header>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Active Subscriptions</div>
        <div class="stat-value">{{ subscriptions|length }}</div>
        <div style="position: absolute; right: 20px; top: 20px; opacity: 0.1">
            <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24">
                <path
                    d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z" />
            </svg>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total Observations</div>
        <div class="stat-value">1,284</div>
        <div style="position: absolute; right: 20px; top: 20px; opacity: 0.1">
            <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24">
                <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
            </svg>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Data Reliability</div>
        <div class="stat-value" style="color: var(--accent)">99.9%</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Pending Alerts</div>
        <div class="stat-value">3</div>
    </div>
</div>

<div class="grid-layout">
    <section class="section-card">
        <div class="section-header">
            <h3 class="section-title">Vegetation Index (NDVI)</h3>
            <select
                style="padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; background: #f8fafc; font-family: inherit;">
                <option>Last 6 Months</option>
                <option>Last Year</option>
            </select>
        </div>
        <div class="chart-container" style="position: relative; height: 300px; width: 100%">
            <canvas id="insightsChart"></canvas>
        </div>
    </section>

    <section class="section-card">
        <div class="section-header">
            <h3 class="section-title">My Subscriptions</h3>
        </div>
        <div style="display: flex; flex-direction: column; gap: 16px; max-height: 300px; overflow-y: auto;">
            {% for sub in subscriptions %}
            <div
                style="padding: 16px; background: #f8fafc; border-radius: 12px; border: 1px solid #dae1e7; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px">
                        Product #{{ sub.product_id }}
                    </div>
                    <div
                        style="font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 4px;">
                        <span style="width: 6px; height: 6px; background: var(--accent); border-radius: 50%;"></span>
                        {{ sub.status|title }}
                    </div>
                </div>
            </div>
            {% empty %}
            <div style="text-align: center; padding: 32px 0; color: var(--text-muted);">
                <p style="margin: 0;">No active subscriptions</p>
                <p style="font-size: 13px;">Browse products below</p>
            </div>
            {% endfor %}
        </div>
    </section>
</div>

<section>
    <h3 class="section-title" style="margin-bottom: 24px; font-size: 24px">Available Intelligence Products</h3>
    <div class="product-grid">
        {% for product in products %}
        <div class="product-card">
            <div style="flex: 1">
                <div
                    style="color: var(--primary); font-size: 13px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px;">
                    Premium Data
                </div>
                <h4 style="margin: 0 0 8px 0; font-size: 20px">{{ product.name }}</h4>
                <p style="margin: 0; color: var(--text-muted); font-size: 15px; line-height: 1.5;">{{
                    product.description }}</p>
            </div>
            <div style="margin-top: 16px; border-top: 1px solid #f1f5f9; padding-top: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 16px;">
                    <span style="font-size: 13px; color: var(--text-muted)">Starting at</span>
                    <span class="product-price">{{ product.price }}</span>
                </div>
                <a href="{% url 'subscribe' product.id %}" class="btn-subscribe">Subscribe Now</a>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    {
        const ctx = document.getElementById("insightsChart").getContext("2d");

        // Gradient for chart
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, "rgba(37, 99, 235, 0.2)");
        gradient.addColorStop(1, "rgba(37, 99, 235, 0)");

        new Chart(ctx, {
            type: "line",
            data: {
                labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
                datasets: [
                    {
                        label: "Vegetation Index (NDVI)",
                        data: [0.65, 0.59, 0.8, 0.81, 0.56, 0.55],
                        fill: true,
                        borderColor: "#2563eb",
                        backgroundColor: gradient,
                        tension: 0.4,
                        pointBackgroundColor: "#ffffff",
                        pointBorderColor: "#2563eb",
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        backgroundColor: "#1e293b",
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: { family: "Outfit", size: 14 },
                        bodyFont: { family: "Outfit", size: 13 },
                    },
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { font: { family: "Outfit" } },
                    },
                    y: {
                        beginAtZero: false,
                        grid: { borderDash: [4, 4], color: "#e2e8f0" },
                        ticks: { font: { family: "Outfit" } },
                        min: 0.4,
                        max: 1.0,
                    },
                },
                interaction: {
                    mode: "index",
                    intersect: false,
                },
            },
        });
    }
</script>
{% endblock %}