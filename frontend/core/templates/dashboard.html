{% extends 'base.html' %}

{% block title %}GeoScope Dashboard{% endblock %}

{% block content %}
<header class="header">
    <div class="welcome">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 8px;">
            <h1>Overview</h1>
            {% if backend_connected %}
            <span class="status-badge" style="background: #dcfce7; color: #166534">
                <span style="width: 8px; height: 8px; background: #22c55e; border-radius: 50%;"></span>
                System Online
            </span>
            {% else %}
            <span class="status-badge" style="background: #fee2e2; color: #991b1b">
                <span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span>
                API Disconnected
            </span>
            {% endif %}
        </div>
        <p>Welcome back, {{ username }}. Here is your geospatial intelligence summary.</p>
    </div>
    <div class="user-profile">
        <div class="avatar">{{ username|slice:":1"|upper }}</div>
        <div style="display: flex; flex-direction: column">
            <span style="font-size: 14px; font-weight: 600; color: var(--text-main)">{{ username }}</span>
            <span style="font-size: 12px; color: var(--text-muted)">{{ plan_name }}</span>
        </div>
    </div>
</header>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Active Subscriptions</div>
        <div class="stat-value">{{ subscriptions|length }}</div>
        <div style="position: absolute; right: 20px; top: 20px; opacity: 0.1">
            <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24">
                <path
                    d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z" />
            </svg>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total Observations</div>
        <div class="stat-value">1,284</div>
        <div style="position: absolute; right: 20px; top: 20px; opacity: 0.1">
            <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24">
                <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
            </svg>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Data Reliability</div>
        <div class="stat-value" style="color: var(--accent)">99.9%</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Pending Alerts</div>
        <div class="stat-value">3</div>
    </div>
</div>

<div class="grid-layout">
    <section class="section-card" style="grid-column: 1 / -1;">
        <div class="section-header">
            <h3 class="section-title">API Consumption (Real-time)</h3>
            <div style="font-size: 13px; color: var(--text-muted);">
                Auto-updates every 2s
            </div>
        </div>
        <div class="chart-container" style="position: relative; height: 350px; width: 100%">
            <canvas id="apiUsageChart"></canvas>
        </div>
    </section>
</div>

{% endblock %}

{% block scripts %}
<script>
    {
        const backendUrl = "{{ BACKEND_URL }}";
        const ctx = document.getElementById("apiUsageChart").getContext("2d");

        // Gradient for chart
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, "rgba(37, 99, 235, 0.2)");
        gradient.addColorStop(1, "rgba(37, 99, 235, 0)");

        const chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: [],
                datasets: [
                    {
                        label: "API Calls (Last Hour)",
                        data: [],
                        fill: true,
                        borderColor: "#2563eb",
                        backgroundColor: gradient,
                        tension: 0.4,
                        pointBackgroundColor: "#ffffff",
                        pointBorderColor: "#2563eb",
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    },
                ],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        backgroundColor: "#1e293b",
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: { family: "Outfit", size: 14 },
                        bodyFont: { family: "Outfit", size: 13 },
                    },
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { font: { family: "Outfit" } },
                    },
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [4, 4], color: "#e2e8f0" },
                        ticks: { font: { family: "Outfit" }, precision: 0 },
                    },
                },
                interaction: {
                    mode: "index",
                    intersect: false,
                },
            },
        });

        window.runSimulation = async function () {
            try {
                const btn = document.querySelector('button[onclick="runSimulation()"]');
                const originalText = btn.innerText;
                btn.innerText = "...";
                btn.disabled = true;

                const response = await fetch(`${backendUrl}/api/simulate-traffic`, { method: 'POST' });
                if (response.ok) {
                    fetchUsageData();
                    btn.innerText = "Done!";
                    setTimeout(() => {
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
            } catch (e) {
                console.error(e);
            }
        };

        async function fetchUsageData() {
            try {
                const response = await fetch(`${backendUrl}/api/usage-stats`);
                const data = await response.json();

                chart.data.labels = data.labels;
                chart.data.datasets[0].data = data.data;
                chart.update();
            } catch (error) {
                console.error('Error fetching usage stats:', error);
            }
        }

        // Initial fetch
        fetchUsageData();

        // Poll every 2 seconds
        setInterval(fetchUsageData, 2000);
    }
</script>
{% endblock %}