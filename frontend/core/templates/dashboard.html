{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoScope Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'dashboard.css' %}" />
  </head>

  <body>
    <div class="sidebar">
      <div class="brand">
        <div
          style="
            width: 32px;
            height: 32px;
            background: var(--primary);
            border-radius: 8px;
          "
        ></div>
        <span>GeoScope</span>
      </div>
      <nav class="nav-links">
        <a href="{% url 'dashboard' %}" class="nav-item active">
          <span>Dashboard</span>
        </a>
        <a href="{% url 'subscriptions' %}" class="nav-item">
          <span>Subscriptions</span>
        </a>
        <a href="#" class="nav-item">
          <span>Observations</span>
        </a>
        <a href="#" class="nav-item">
          <span>Satellites</span>
        </a>
        <a href="#" class="nav-item">
          <span>Analytics</span>
        </a>
        <a href="#" class="nav-item">
          <span>Settings</span>
        </a>
      </nav>
      <a href="/login/" class="btn-logout">
        <span>Log Out</span>
      </a>
    </div>

    <main class="main-content">
      <header class="header">
        <div class="welcome">
          <div
            style="
              display: flex;
              align-items: center;
              gap: 16px;
              margin-bottom: 8px;
            "
          >
            <h1>Overview</h1>
            {% if backend_connected %}
            <span
              class="status-badge"
              style="background: #dcfce7; color: #166534"
            >
              <span
                style="
                  width: 8px;
                  height: 8px;
                  background: #22c55e;
                  border-radius: 50%;
                "
              ></span>
              System Online
            </span>
            {% else %}
            <span
              class="status-badge"
              style="background: #fee2e2; color: #991b1b"
            >
              <span
                style="
                  width: 8px;
                  height: 8px;
                  background: #ef4444;
                  border-radius: 50%;
                "
              ></span>
              API Disconnected
            </span>
            {% endif %}
          </div>
          <p>
            Welcome back, {{ username }}. Here is your geospatial intelligence
            summary.
          </p>
        </div>
        <div class="user-profile">
          <div class="avatar">{{ username|slice:":1"|upper }}</div>
          <div style="display: flex; flex-direction: column">
            <span
              style="font-size: 14px; font-weight: 600; color: var(--text-main)"
              >{{ username }}</span
            >
            <span style="font-size: 12px; color: var(--text-muted)"
              >Standard Plan</span
            >
          </div>
        </div>
      </header>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Active Subscriptions</div>
          <div class="stat-value">{{ subscriptions|length }}</div>
          <div style="position: absolute; right: 20px; top: 20px; opacity: 0.1">
            <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"
              />
            </svg>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Observations</div>
          <div class="stat-value">1,284</div>
          <div style="position: absolute; right: 20px; top: 20px; opacity: 0.1">
            <svg width="60" height="60" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"
              />
            </svg>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Data Reliability</div>
          <div class="stat-value" style="color: var(--accent)">99.9%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Pending Alerts</div>
          <div class="stat-value">3</div>
        </div>
      </div>

      <div class="grid-layout">
        <section class="section-card">
          <div class="section-header">
            <h3 class="section-title">Vegetation Index (NDVI)</h3>
            <select
              style="
                padding: 8px 12px;
                border-radius: 8px;
                border: 1px solid #e2e8f0;
                background: #f8fafc;
                font-family: inherit;
              "
            >
              <option>Last 6 Months</option>
              <option>Last Year</option>
            </select>
          </div>
          <div
            class="chart-container"
            style="position: relative; height: 300px; width: 100%"
          >
            <canvas id="insightsChart"></canvas>
          </div>
        </section>

        <section class="section-card">
          <div class="section-header">
            <h3 class="section-title">My Subscriptions</h3>
          </div>
          <div
            style="
              display: flex;
              flex-direction: column;
              gap: 16px;
              max-height: 300px;
              overflow-y: auto;
            "
          >
            {% for sub in subscriptions %}
            <div
              style="
                padding: 16px;
                background: #f8fafc;
                border-radius: 12px;
                border: 1px solid #dae1e7;
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <div>
                <div
                  style="font-weight: 600; font-size: 14px; margin-bottom: 4px"
                >
                  Product #{{ sub.product_id }}
                </div>
                <div
                  style="
                    font-size: 12px;
                    color: var(--text-muted);
                    display: flex;
                    align-items: center;
                    gap: 4px;
                  "
                >
                  <span
                    style="
                      width: 6px;
                      height: 6px;
                      background: var(--accent);
                      border-radius: 50%;
                    "
                  ></span>
                  {{ sub.status|title }}
                </div>
              </div>
            </div>
            {% empty %}
            <div
              style="
                text-align: center;
                padding: 32px 0;
                color: var(--text-muted);
              "
            >
              <p style="margin: 0">No active subscriptions</p>
              <p style="font-size: 13px">Browse products below</p>
            </div>
            {% endfor %}
          </div>
        </section>
      </div>

      <!-- JWT Token Management -->
      <section class="token-manager">
        <div class="token-card">
          <div class="section-header" style="padding: 0; margin-bottom: 12px">
            <div>
              <h3 class="section-title" style="margin: 0">
                JWT Token Management
              </h3>
              <small style="color: var(--text-muted)"
                >Manage your authentication tokens</small
              >
            </div>
          </div>

          <label for="accessToken" style="font-weight: 600; font-size: 13px"
            >Your Access Token</label
          >
          <textarea id="accessToken" class="token-textarea">
{{ access_token|default:'' }}</textarea
          >

          <div class="token-controls">
            <button id="validateBtn" class="btn-subscribe btn-validate">
              Validate Token
            </button>
            <button id="refreshBtn" class="btn-subscribe btn-refresh">
              Refresh Token
            </button>
            <button id="saveBtn" class="btn-subscribe btn-save">
              Save Token
            </button>
          </div>
        </div>

        <aside style="display: flex; flex-direction: column; gap: 12px">
          <div class="token-status">
            <div style="font-weight: 700">Token Status</div>
            <div
              id="tokenStatus"
              style="
                padding: 6px 10px;
                border-radius: 999px;
                background: #fde68a;
                color: #92400e;
                font-weight: 600;
              "
            >
              Unknown
            </div>
          </div>

          <div id="tokenMeta" class="token-meta">&nbsp;</div>

          <div class="action-log">
            <div style="font-weight: 700; margin-bottom: 8px">Action Log</div>
            <div id="actionLog"></div>
          </div>

          <!-- Hidden field to hold refresh token -->
          <input
            type="hidden"
            id="refreshToken"
            value="{{ refresh_token|default:'' }}"
          />
        </aside>
      </section>

      <section>
        <h3 class="section-title" style="margin-bottom: 24px; font-size: 24px">
          Available Intelligence Products
        </h3>
        <div class="product-grid">
          {% for product in products %}
          <div class="product-card">
            <div style="flex: 1">
              <div
                style="
                  color: var(--primary);
                  font-size: 13px;
                  font-weight: 700;
                  text-transform: uppercase;
                  margin-bottom: 8px;
                "
              >
                Premium Data
              </div>
              <h4 style="margin: 0 0 8px 0; font-size: 20px">
                {{ product.name }}
              </h4>
              <p
                style="
                  margin: 0;
                  color: var(--text-muted);
                  font-size: 15px;
                  line-height: 1.5;
                "
              >
                {{ product.description }}
              </p>
            </div>
            <div
              style="
                margin-top: 16px;
                border-top: 1px solid #f1f5f9;
                padding-top: 16px;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: flex-end;
                  margin-bottom: 16px;
                "
              >
                <span style="font-size: 13px; color: var(--text-muted)"
                  >Starting at</span
                >
                <span class="product-price">{{ product.price }}</span>
              </div>
              <a href="{% url 'subscribe' product.id %}" class="btn-subscribe"
                >Subscribe Now</a
              >
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      {
        const ctx = document.getElementById("insightsChart").getContext("2d");

        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, "rgba(37, 99, 235, 0.2)");
        gradient.addColorStop(1, "rgba(37, 99, 235, 0)");

        new Chart(ctx, {
          type: "line",
          data: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
            datasets: [
              {
                label: "Vegetation Index (NDVI)",
                data: [0.65, 0.59, 0.8, 0.81, 0.56, 0.55],
                fill: true,
                borderColor: "#2563eb",
                backgroundColor: gradient,
                tension: 0.4,
                pointBackgroundColor: "#ffffff",
                pointBorderColor: "#2563eb",
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                backgroundColor: "#1e293b",
                padding: 12,
                cornerRadius: 8,
                titleFont: { family: "Outfit", size: 14 },
                bodyFont: { family: "Outfit", size: 13 },
              },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { font: { family: "Outfit" } },
              },
              y: {
                beginAtZero: false,
                grid: { borderDash: [4, 4], color: "#e2e8f0" },
                ticks: { font: { family: "Outfit" } },
                min: 0.4,
                max: 1.0,
              },
            },
            interaction: {
              mode: "index",
              intersect: false,
            },
          },
        });
      }
    </script>

    <script>
      window.BACKEND_URL = "{{ backend_url }}";
    </script>
    <script src="{% static 'app.js' %}"></script>
  </body>
</html>
